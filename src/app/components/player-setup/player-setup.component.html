<div class="player-setup-container" role="main">
  <!-- Help Button - Always visible -->
  <button type="button" class="btn-help-floating" (click)="openHelpModal()" title="H∆∞·ªõng d·∫´n ch∆°i">
    ‚ùì H∆∞·ªõng d·∫´n
  </button>

  <!-- Step 1: Initial Configuration -->
  <div class="initial-config" *ngIf="!showPlayerNameForm">
    <div class="config-card">
      <h2>C·∫•u h√¨nh Game</h2>
      <p class="instruction">
        Nh·∫≠p s·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i (t·ªëi thi·ªÉu {{ MIN_PLAYERS }}) v√† s·ªë l∆∞·ª£ng team ({{ MIN_TEAMS }}-{{ MAX_TEAMS }}).
      </p>

      <div class="form-group">
        <label for="playerCount">S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i:</label>
        <input
          type="number"
          id="playerCount"
          name="playerCount"
          [(ngModel)]="playerCount"
          [min]="MIN_PLAYERS"
          class="input-field"
          [class.error]="playerCountError"
          placeholder="V√≠ d·ª•: 34"
          autocomplete="off"
        />
        <div class="error-message" *ngIf="playerCountError">{{ playerCountError }}</div>
      </div>

      <div class="form-group">
        <label for="teamCount">S·ªë l∆∞·ª£ng team:</label>
        <input
          type="number"
          id="teamCount"
          name="teamCount"
          [(ngModel)]="teamCount"
          [min]="MIN_TEAMS"
          [max]="MAX_TEAMS"
          class="input-field"
          [class.error]="teamCountError"
          (keyup.enter)="onPlayerCountSubmit()"
          placeholder="V√≠ d·ª•: 7"
          autocomplete="off"
        />
        <div class="error-message" *ngIf="teamCountError">{{ teamCountError }}</div>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-primary" (click)="onPlayerCountSubmit()">
          Ti·∫øp theo
        </button>
      </div>
    </div>
  </div>

  <!-- Step 2: Main Configuration Grid (3 columns) -->
  <div class="main-config-grid" *ngIf="showPlayerNameForm">
    <form (ngSubmit)="onPlayerNamesSubmit()" class="config-form" novalidate>
      
      <!-- Column 1: Team Colors -->
      <div class="config-card team-colors-card">
        <h3>üé® M√†u s·∫Øc Team</h3>
        <p class="card-instruction">Ch·ªçn m√†u cho m·ªói team</p>
        
        <div class="team-colors-list">
          <div class="team-color-row" *ngFor="let team of teams; let i = index">
            <span class="team-label">Team {{ i + 1 }}:</span>
            <div class="color-picker">
              <button 
                *ngFor="let color of availableColors"
                type="button"
                class="color-btn"
                [style.background]="color.value"
                [class.selected]="team.color === color.value"
                [class.disabled]="isColorUsed(color.value, team.id)"
                [disabled]="isColorUsed(color.value, team.id)"
                (click)="selectTeamColor(team.id, color.value)"
                [attr.title]="color.name">
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Column 2: Player Names -->
      <div class="config-card player-names-card">
        <h3>üë• Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i</h3>
        <p class="card-instruction">{{ playerNames.length }} ng∆∞·ªùi ch∆°i</p>

        <div class="general-error" *ngIf="generalError">{{ generalError }}</div>

        <div class="player-inputs-container">
          <div class="player-row" *ngFor="let player of playerNames; let i = index">
            <input
              type="number"
              class="order-input"
              [class.order-duplicate]="isDuplicateOrder(i)"
              [(ngModel)]="player.order"
              [name]="'order-' + i"
              [min]="1"
              [max]="playerNames.length"
              placeholder=""
              title="Nh·∫≠p s·ªë th·ª© t·ª± ch∆°i"
            />
            <input
              type="text"
              [id]="'player-' + i"
              [name]="'player-' + i"
              [(ngModel)]="player.name"
              class="input-field player-name-input"
              [class.error]="player.error"
              [class.valid]="player.name.trim() && !player.error"
              (blur)="onPlayerNameBlur(i)"
              (input)="onPlayerNameInput(i)"
              placeholder="T√™n ng∆∞·ªùi ch∆°i"
              maxlength="50"
              autocomplete="off"
            />
            <select
              [id]="'team-' + i"
              [name]="'team-' + i"
              [(ngModel)]="player.teamId"
              class="team-dropdown"
            >
              <option *ngFor="let team of teams; let j = index" [value]="team.id">
                T{{ j + 1 }}
              </option>
            </select>
            <span 
              class="team-color-dot" 
              [style.background]="getTeamById(player.teamId)?.color || '#ccc'">
            </span>
            <button 
              type="button" 
              class="delete-btn" 
              (click)="removePlayer(i)"
              title="X√≥a ng∆∞·ªùi ch∆°i">‚úï</button>
            <div class="player-error" *ngIf="player.error">{{ player.error }}</div>
          </div>
        </div>
        
        <!-- Add player button -->
        <div class="add-player-section">
          <button type="button" class="btn btn-add-player" (click)="addPlayer()">
            + Th√™m ng∆∞·ªùi ch∆°i
          </button>
        </div>
      </div>

      <!-- Column 3: Game Settings (Map Type + Winning Positions + Actions) -->
      <div class="config-card game-settings-card">
        <!-- Map Type Section -->
        <div class="settings-section map-type-section">
          <h3>üó∫Ô∏è Ch·∫ø ƒë·ªô Map</h3>
          <div class="map-options">
            <label class="radio-option">
              <input type="radio" name="mapType" value="random" [(ngModel)]="mapType" />
              <span class="option-label">Random Map</span>
              <span class="map-description">V·ªã tr√≠ r·∫Øn v√† thang ng·∫´u nhi√™n</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="mapType" value="fixed" [(ngModel)]="mapType" />
              <span class="option-label">Fixed Map</span>
              <span class="map-description">V·ªã tr√≠ r·∫Øn v√† thang c·ªë ƒë·ªãnh</span>
            </label>
          </div>
          <button type="button" class="btn btn-preview" (click)="openMapPreview()">
            Xem tr∆∞·ªõc Map
          </button>
        </div>

        <div class="section-divider"></div>

        <!-- Winning Positions Section -->
        <div class="settings-section winning-positions-section">
          <h3>üèÜ V·ªã tr√≠ chi·∫øn th·∫Øng</h3>
          <p class="card-instruction">Nh·∫≠p v·ªã tr√≠ t·ª´ 1-{{ playerCount }}</p>

          <div class="positions-display">
            <span class="position-badge additional" *ngFor="let pos of additionalWinningPositions">
              ‚≠ê #{{ pos }}
              <button type="button" class="remove-btn" (click)="removeWinningPosition(pos)">‚úï</button>
            </span>
            <span class="no-positions" *ngIf="additionalWinningPositions.length === 0">
              Ch∆∞a c√≥ v·ªã tr√≠ n√†o
            </span>
          </div>

          <div class="add-position-row">
            <input
              type="number"
              class="input-field position-input"
              [(ngModel)]="newWinningPosition"
              [name]="'newWinningPosition'"
              (input)="onWinningPositionInput()"
              (keyup.enter)="addWinningPosition()"
              [min]="1"
              [max]="playerCount"
              placeholder="V·ªã tr√≠"
              [class.error]="winningPositionError"
            />
            <button
              type="button"
              class="btn btn-add"
              (click)="addWinningPosition()"
              [disabled]="!isValidWinningPosition()">
              + Th√™m
            </button>
          </div>
          <div class="error-message" *ngIf="winningPositionError">{{ winningPositionError }}</div>
        </div>

        <div class="section-divider"></div>

        <!-- Action Buttons -->
        <div class="action-buttons-section">
          <button type="button" class="btn btn-secondary" (click)="goBackToPlayerCount()">
            ‚Üê Quay l·∫°i
          </button>
          <button type="submit" class="btn btn-primary btn-start">
            üéÆ B·∫Øt ƒë·∫ßu ch∆°i
          </button>
        </div>
      </div>

    </form>
  </div>
</div>


<!-- Map Preview Modal -->
<div class="map-preview-modal" *ngIf="showMapPreview" (click)="closeMapPreview()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ mapType === 'fixed' ? 'üó∫Ô∏è Fixed Map' : 'üé≤ Random Map' }}</h3>
      <button type="button" class="close-btn" (click)="closeMapPreview()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="preview-board-container">
        <div class="preview-board-wrapper">
          <div class="preview-board-grid">
            <div class="preview-board-row" *ngFor="let row of previewBoardRows">
              <div 
                class="preview-board-cell" 
                *ngFor="let cell of row"
                [style.background-color]="getPreviewCellColor(cell)">
                <span class="preview-cell-number">{{ cell.number }}</span>
              </div>
            </div>
          </div>
          
          <!-- Snakes and Ladders Overlay -->
          <svg class="preview-snakes-ladders-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
            <defs>
              <linearGradient id="previewSnakeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#dc3545;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#c82333;stop-opacity:1" />
              </linearGradient>
              <linearGradient id="previewLadderGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#28a745;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#218838;stop-opacity:1" />
              </linearGradient>
              <marker id="previewSnakeArrow" markerWidth="5" markerHeight="5" refX="2.5" refY="2.5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L5,2.5 L0,5 Z" fill="#dc3545" />
              </marker>
              <marker id="previewLadderArrow" markerWidth="5" markerHeight="5" refX="2.5" refY="2.5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L5,2.5 L0,5 Z" fill="#28a745" />
              </marker>
            </defs>
            
            <g *ngFor="let element of previewSnakesAndLadders">
              <path 
                [attr.d]="getPreviewPath(element)"
                [attr.stroke]="element.type === 'snake' ? 'url(#previewSnakeGradient)' : 'url(#previewLadderGradient)'"
                stroke-width="0.8"
                fill="none"
                [attr.marker-end]="element.type === 'snake' ? 'url(#previewSnakeArrow)' : 'url(#previewLadderArrow)'"
                class="preview-element-path" />
              
              <circle 
                [attr.cx]="(getPreviewCellPosition(element.startPosition)!.x + 0.5) * 10"
                [attr.cy]="(9 - getPreviewCellPosition(element.startPosition)!.y + 0.5) * 10"
                r="1.2"
                stroke="white"
                stroke-width="0.2"
                [attr.fill]="element.type === 'snake' ? '#dc3545' : '#28a745'"
                opacity="0.9" />
            </g>
          </svg>
        </div>
      </div>
      
      <div class="preview-legend">
        <div class="legend-item">
          <span class="legend-color ladder"></span>
          <span>Thang ({{ getPreviewLadderCount() }})</span>
        </div>
        <div class="legend-item">
          <span class="legend-color snake"></span>
          <span>R·∫Øn ({{ getPreviewSnakeCount() }})</span>
        </div>
      </div>
      
      <div class="preview-actions" *ngIf="mapType === 'random'">
        <button type="button" class="btn btn-secondary" (click)="regenerateRandomMap()">
          üîÑ T·∫°o map m·ªõi
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="help-modal" *ngIf="showHelpModal" (click)="closeHelpModal()">
  <div class="help-modal-content" (click)="$event.stopPropagation()">
    <div class="help-modal-header">
      <h3>üìñ H∆∞·ªõng d·∫´n ch∆°i</h3>
      <button type="button" class="close-btn" (click)="closeHelpModal()">‚úï</button>
    </div>
    <div class="help-modal-body">
      <!-- Step 1 -->
      <div class="help-section">
        <h4>üéØ B∆∞·ªõc 1: Thi·∫øt l·∫≠p game</h4>
        <ol>
          <li>Nh·∫≠p s·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i (t·ªëi thi·ªÉu 2)</li>
          <li>Nh·∫≠p t√™n v√† ch·ªçn ƒë·ªôi cho t·ª´ng ng∆∞·ªùi ch∆°i</li>
          <li>Ch·ªçn ch·∫ø ƒë·ªô map (Random ho·∫∑c Fixed)</li>
          <li>Nh·∫•n "B·∫Øt ƒë·∫ßu ch∆°i"</li>
        </ol>
      </div>

      <!-- Step 2 -->
      <div class="help-section">
        <h4>üéÆ B∆∞·ªõc 2: Ch∆°i game</h4>
        <ol>
          <li><strong>Ng∆∞·ªùi tung x√∫c x·∫Øc</strong> ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü panel b√™n tr√°i</li>
          <li><strong>Ch·ªçn ng∆∞·ªùi di chuy·ªÉn</strong> t·ª´ b·∫£ng x·∫øp h·∫°ng (c√≥ th·ªÉ ch·ªçn b·∫•t k·ª≥ ai trong ƒë·ªôi)</li>
          <li><strong>Nh·∫•n n√∫t tung x√∫c x·∫Øc</strong> ƒë·ªÉ tung</li>
          <li>Qu√¢n c·ªù s·∫Ω t·ª± ƒë·ªông di chuy·ªÉn theo s·ªë ƒëi·ªÉm</li>
          <li>N·∫øu ƒë·ª©ng v√†o thang, ch·ªçn leo l√™n ho·∫∑c ·ªü l·∫°i (5 gi√¢y)</li>
          <li>N·∫øu ƒë·ª©ng v√†o ƒë·∫ßu r·∫Øn, t·ª± ƒë·ªông tr∆∞·ª£t xu·ªëng</li>
        </ol>
      </div>

      <!-- Step 3 -->
      <div class="help-section">
        <h4>üèÜ B∆∞·ªõc 3: Chi·∫øn th·∫Øng</h4>
        <ul>
          <li>Ng∆∞·ªùi ch∆°i ƒë·∫ßu ti√™n ƒë·∫øn √¥ 100 s·∫Ω v·ªÅ nh·∫•t</li>
          <li>Ph·∫£i tung ƒë√∫ng s·ªë ƒëi·ªÉm ƒë·ªÉ v·ªÅ ƒë√≠ch (kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√°)</li>
        </ul>
      </div>

      <!-- Features -->
      <div class="help-section">
        <h4>‚ú® T√≠nh nƒÉng</h4>
        <ul>
          <li><strong>üêç 6 r·∫Øn</strong> - khi·∫øn ng∆∞·ªùi ch∆°i b·ªã tr∆∞·ª£t xu·ªëng</li>
          <li><strong>ü™ú 12 thang</strong> - gi√∫p ng∆∞·ªùi ch∆°i leo l√™n nhanh h∆°n</li>
          <li><strong>‚è±Ô∏è ƒê·∫øm ng∆∞·ª£c 15 gi√¢y</strong> cho m·ªói l∆∞·ª£t tung x√∫c x·∫Øc</li>
          <li><strong>üé≤ X√∫c x·∫Øc t√πy ch·ªânh</strong> - c√≥ th·ªÉ c·∫•u h√¨nh s·ªë ƒëi·ªÉm t·ªëi ƒëa</li>
          <li><strong>üíæ T·ª± ƒë·ªông l∆∞u game</strong> - kh√¥i ph·ª•c khi t·∫£i l·∫°i trang</li>
        </ul>
      </div>
    </div>
  </div>
</div>
